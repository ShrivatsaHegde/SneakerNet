# https://docs.github.com/en/actions/reference/encrypted-secrets#using-encrypted-secrets-in-a-workflow
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: travis-docker
on: 
  push:
    branches:
      - docker-multistage

env:      
  DOCKER_PASSWORD: ${{  secrets.DOCKER_PASSWORD }}
  DOCKER_USERNAME: ${{  secrets.DOCKER_USERNAME }}
  CI_PROJECT_NAME: sneakernet

jobs:
  docker_deploy_latest:
    
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
        with:
          ref: docker-multistage
          fetch-depth: 1
      - id:  test-not-so-secret-variable
        run: echo "logging in with ${DOCKER_USERNAME:0:6}"
      - id:  test-docker-tag
        run: echo "$CI_PROJECT_NAME:$GITHUB_SHA"
      - id:  test-other-vars
        run: echo "HOME:$HOME PWD:$PWD GITHUB_WORKSPACE:$GITHUB_WORKSPACE $GITHUB_ACTOR/$CI_PROJECT_NAME:$GITHUB_SHA"
      - id:  test-github-root
        run: ls -R $GITHUB_WORKSPACE
      - id:  see-if-git-dir-is-good
        run: ls -lha $GITHUB_WORKSPACE
      - id:  docker-build
        run: docker build -t $CI_PROJECT_NAME:$GITHUB_SHA $GITHUB_WORKSPACE
      - id:  docker-tag-latest
        run: |
          REMOTE_TAG=$(echo "$GITHUB_REPOSITORY:$GITHUB_SHA" | tr '[:upper:]' '[:lower:]')
          docker tag $CI_PROJECT_NAME:$GITHUB_SHA $REMOTE_TAG
      - id:  docker-login
        run: echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
      - id:  docker-push-latest
        run: docker push $CI_PROJECT_NAME:$GITHUB_SHA

