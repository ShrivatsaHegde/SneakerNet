language: perl
os: linux
perl:
  - "5.24-shrplib"
script: true
install:
  - echo "Just testing docker on this branch"

after_success:
  - CI_PROJECT_NAME=sneakernet
  - docker build -t $CI_PROJECT_NAME:$TRAVIS_COMMIT .
  - SLUG=$(echo "$TRAVIS_REPO_SLUG" | tr '[:upper:]' '[:lower:]')
  - echo "$CI_PROJECT_NAME"
  - echo $SLUG
  - echo $REPOSITORY_URL
  - echo $TRAVIS_COMMIT
  - DOCKER_PASSWORD=${{secrets.DOCKER_PASSWORD}}
  - DOCKER_USERNAME=${{secrets.DOCKER_USERNAME}}
  - echo $DOCKER_USERNAME
  - echo docker tag $CI_PROJECT_NAME:$TRAVIS_COMMIT $SLUG:$TRAVIS_COMMIT
  -      docker tag $CI_PROJECT_NAME:$TRAVIS_COMMIT $SLUG:$TRAVIS_COMMIT
  -      docker tag $CI_PROJECT_NAME:$TRAVIS_COMMIT $SLUG:latest
  - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin 
  - docker push $CI_PROJECT_NAME:$TRAVIS_COMMIT
  - docker push $CI_PROJECT_NAME:latest 

#https://stackoverflow.com/a/58505735
cache:
  directories:
    - docker_images
before_install:
  - docker load -i docker_images/images.tar || true
before_cache:
  -docker save -o docker_images/images.tar $(docker images -a -q)

# deploying to dockerhub
#deploy:
#  provider: script
#  script: bash .travis-ci/docker_push
#  on:
#    branch: $TRAVIS_BRANCH

